<?xml version="1.0" encoding="UTF-8"?>
<module xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.arhor.by/sql-module ./../sql-module.xsd"
        xmlns="http://www.arhor.by/sql-module"
        name="users">

    <dependencies>
        <dependency name="roles"/>
        <dependency name="langs"/>
    </dependencies>

    <queries context="university">
        <create target="table">
            <![CDATA[
            IF (OBJECT_ID('users') IS NULL)
            BEGIN
                CREATE TABLE users
                (
                    id            BIGINT           NOT NULL IDENTITY(1,1),
                    email         NVARCHAR(255)    NOT NULL,
                    password      NVARCHAR(512)    NOT NULL,
                    first_name    NVARCHAR(50)     NOT NULL,
                    last_name     NVARCHAR(50)     NOT NULL,
                    role_id       BIGINT           NOT NULL,
                    lang_id       BIGINT           NOT NULL,

                    CONSTRAINT PK_users PRIMARY KEY CLUSTERED (id ASC),

                    CONSTRAINT FK_users_role_id FOREIGN KEY (role_id)
                    REFERENCES roles (id)
                        ON DELETE CASCADE
                        ON UPDATE CASCADE,

                    CONSTRAINT FK_users_langs_id FOREIGN KEY (lang_id)
                    REFERENCES langs (id)
                        ON DELETE CASCADE
                        ON UPDATE CASCADE
                )
                CREATE UNIQUE NONCLUSTERED INDEX IDX_users_email ON users (email ASC)
            END
            ]]>
        </create>

        <drop target="trigger">
            <![CDATA[
            IF OBJECT_ID('TR_users_audit_modification','TR') IS NOT NULL
            BEGIN
                DROP TRIGGER TR_users_audit_modification
            END
            ]]>
        </drop>

        <create target="trigger">
            <![CDATA[
            CREATE TRIGGER TR_users_audit_modification ON users
                FOR UPDATE
            AS
            BEGIN
                DECLARE @login_name VARCHAR(128) = (
                    SELECT login_name
                    FROM sys.dm_exec_sessions
                    WHERE session_id = @@SPID
                )

                DECLARE @field_name VARCHAR(64)
                      , @old_value  NVARCHAR(512)
                      , @new_value  NVARCHAR(512)

                IF UPDATE(email)
                BEGIN
                    SET @field_name = 'email'
            		SELECT @old_value = CAST(email AS NVARCHAR(512)) FROM deleted
                    SELECT @new_value = CAST(email AS NVARCHAR(512)) FROM inserted

            		IF (@old_value != @new_value)
            		BEGIN
            			INSERT INTO users_audit_modification
                        (
                            user_id,
                            field_name,
                            old_value,
                            new_value,
                            modified_by,
                            modified_date
                        )
                        SELECT id
	            	         , @field_name
	            		     , @old_value
	            		     , @new_value
	            		     , @login_name
	            		     , GETDATE()
                        FROM inserted
	            	END
                END

                IF UPDATE(password)
                BEGIN
                    SET @field_name = 'password'
            		SELECT @old_value = CAST(password AS NVARCHAR(512)) FROM deleted
                    SELECT @new_value = CAST(password AS NVARCHAR(512)) FROM inserted

                    IF (@old_value != @new_value)
            		BEGIN
            			INSERT INTO users_audit_modification
                        (
                            user_id,
                            field_name,
                            old_value,
                            new_value,
                            modified_by,
                            modified_date
                        )
                        SELECT id
            		         , @field_name
            			     , @old_value
            			     , @new_value
            			     , @login_name
            			     , GETDATE()
                        FROM inserted
            		END
                END

                IF UPDATE(first_name)
                BEGIN
                    SET @field_name = 'first_name'
            		SELECT @old_value = CAST(first_name AS NVARCHAR(512)) FROM deleted
                    SELECT @new_value = CAST(first_name AS NVARCHAR(512)) FROM inserted

                    IF (@old_value != @new_value)
            		BEGIN
            			INSERT INTO users_audit_modification
                        (
                            user_id,
                            field_name,
                            old_value,
                            new_value,
                            modified_by,
                            modified_date
                        )
                        SELECT id
            		         , @field_name
            			     , @old_value
	            		     , @new_value
            			     , @login_name
            			     , GETDATE()
                        FROM inserted
            		END
                END

                IF UPDATE(last_name)
                BEGIN
                    SET @field_name = 'last_name'
            		SELECT @old_value = CAST(last_name AS NVARCHAR(512)) FROM deleted
                    SELECT @new_value = CAST(last_name AS NVARCHAR(512)) FROM inserted

                    IF (@old_value != @new_value)
            		BEGIN
            			INSERT INTO users_audit_modification
                        (
                            user_id,
                            field_name,
                            old_value,
                            new_value,
                            modified_by,
                            modified_date
                        )
                        SELECT id
            		         , @field_name
            			     , @old_value
            			     , @new_value
            			     , @login_name
            			     , GETDATE()
                        FROM inserted
            		END
                END

                IF UPDATE(role_id)
                BEGIN
                    SET @field_name = 'role_id'
            		SELECT @old_value = CAST(role_id AS NVARCHAR(512)) FROM deleted
                    SELECT @new_value = CAST(role_id AS NVARCHAR(512)) FROM inserted

                    IF (@old_value != @new_value)
	            	BEGIN
	            		INSERT INTO users_audit_modification
                        (
                            user_id,
                            field_name,
                            old_value,
                            new_value,
                            modified_by,
                            modified_date
                        )
                        SELECT id
            		         , @field_name
	            		     , @old_value
	            		     , @new_value
            			     , @login_name
            			     , GETDATE()
                        FROM inserted
	            	END
                END

                IF UPDATE(lang_id)
                BEGIN
                    SET @field_name = 'lang_id'
            		SELECT @old_value = CAST(lang_id AS NVARCHAR(512)) FROM deleted
                    SELECT @new_value = CAST(lang_id AS NVARCHAR(512)) FROM inserted

                    IF (@old_value != @new_value)
            		BEGIN
            			INSERT INTO users_audit_modification
                        (
                            user_id,
                            field_name,
                            old_value,
                            new_value,
                            modified_by,
                            modified_date
                        )
                        SELECT id
            		         , @field_name
            			     , @old_value
            			     , @new_value
            			     , @login_name
            			     , GETDATE()
                        FROM inserted
            		END
                END
            END
            ]]>
        </create>
    </queries>

</module>
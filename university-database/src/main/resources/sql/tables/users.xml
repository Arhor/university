<?xml version="1.0" encoding="UTF-8"?>
<module xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.arhor.by/sql-module ./../sql-module.xsd"
        xmlns="http://www.arhor.by/sql-module"
        name="users">

    <dependencies>
        <dependency name="roles"/>
        <dependency name="langs"/>
    </dependencies>

    <queries context="university">
        <create target="table">
            <![CDATA[
            IF (OBJECT_ID('users') IS NULL)
            BEGIN
                CREATE TABLE users
                (
                    id            BIGINT           NOT NULL IDENTITY(1,1),
                    email         NVARCHAR(255)    NOT NULL,
                    password      NVARCHAR(512)    NOT NULL,
                    first_name    NVARCHAR(50)     NOT NULL,
                    last_name     NVARCHAR(50)     NOT NULL,
                    role_id       BIGINT           NOT NULL,
                    lang_id       BIGINT           NOT NULL,

                    CONSTRAINT PK_users PRIMARY KEY CLUSTERED (id ASC),

                    CONSTRAINT FK_users_role_id FOREIGN KEY (role_id)
                    REFERENCES roles (id)
                        ON DELETE CASCADE
                        ON UPDATE CASCADE,

                    CONSTRAINT FK_users_langs_id FOREIGN KEY (lang_id)
                    REFERENCES langs (id)
                        ON DELETE CASCADE
                        ON UPDATE CASCADE
                )
                CREATE UNIQUE NONCLUSTERED INDEX IDX_users_email ON users (email ASC)
            END
            ]]>
        </create>

        <create target="table">
            <![CDATA[
            IF (OBJECT_ID('users_audit') IS NULL)
            BEGIN
                CREATE TABLE users_audit
                (
                    id               BIGINT           NOT NULL IDENTITY(1, 1),
                    user_id          BIGINT           NOT NULL,
                    email            NVARCHAR(255)    NOT NULL,
                    password         NVARCHAR(512)    NOT NULL,
                    first_name       NVARCHAR(50)     NOT NULL,
                    last_name        NVARCHAR(50)     NOT NULL,
                    role_id          BIGINT           NOT NULL,
                    modified_by      DATETIME         NOT NULL,
                    modified_date    DATETIME         NOT NULL,
                    operation        VARCHAR(20)      NOT NULL,

                    CONSTRAINT PK_users_audit PRIMARY KEY CLUSTERED (id ASC),

                    CONSTRAINT CHK_users_audit_operation
                    CHECK (operation in ('CREATED', 'DELETED'))
                )
            END
            ]]>
        </create>

        <create target="trigger">
            <![CDATA[
            CREATE TRIGGER TR_users_audit ON users
                FOR INSERT, DELETE
            AS
            BEGIN
                DECLARE @login_name VARCHAR(128) = (
                    SELECT login_name
                    FROM sys.dm_exec_sessions
                    WHERE session_id = @@SPID
                )

                IF EXISTS (SELECT 1 FROM deleted)
                BEGIN
                    INSERT INTO users_audit
                    (
                        user_id,
                        email,
                        password,
                        first_name,
                        last_name,
                        role_id,
                         modified_by,
                        modified_date,
                        operation
                    )
                    SELECT d.id
                         , d.email
                         , d.password
                         , d.first_name
                         , d.last_name
                         , d.role_id
                         , @login_name
                         , GETDATE()
                         , 'DELETED'
                    FROM deleted d
                END
                ELSE
                BEGIN
                    INSERT INTO users_audit
                    (
                        user_id,
                        email,
                        password,
                        first_name,
                        last_name,
                        role_id,
                        modified_by,
                        modified_date,
                        operation
                    )
                    SELECT i.id
                         , i.email
                         , i.password
                         , i.first_name
                         , i.last_name
                         , i.role_id
                         , @login_name
                         , GETDATE()
                         , 'CREATED'
                      FROM inserted i
                END
            END
            ]]>
        </create>

        <create target="table">
            <![CDATA[
            IF (OBJECT_ID('users_audit_modification') IS NULL)
            BEGIN
                CREATE TABLE users_audit_modification
                (
                    id            BIGINT        NOT NULL IDENTITY(1, 1),
                    user_id       BIGINT        NOT NULL,
                    field_name      VARCHAR(64)   NOT NULL,
                    old_value      NVARCHAR(512) NULL,
                    new_value      NVARCHAR(512) NULL,
                    modified_by   DATETIME      NOT NULL,
                    modified_date DATETIME      NOT NULL

                    CONSTRAINT PK_users_audit_modification PRIMARY KEY CLUSTERED (id ASC)
                )
            END
            ]]>
        </create>

        <create target="trigger">
            <![CDATA[

            ]]>
        </create>
    </queries>

</module>